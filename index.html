<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>MDT ‚Äì DoJ & LSPD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root {
    --bg:#05070f; --surface:#0b1220; --panel:#111827; --glass:rgba(17,25,40,.75);
    --accent:#4f46e5; --accent-2:#22d3ee; --danger:#ef4444; --success:#22c55e;
    --judge:#facc15; --lspd:#3b82f6; --marshal:#22c55e; --doj:#a855f7; --text:#e5e7eb; --muted:#94a3b8;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,sans-serif; 
    background:radial-gradient(1200px 600px at 10% -20%,#1e293b,transparent),
               radial-gradient(800px 400px at 90% 10%,#020617,transparent),
               var(--bg); color:var(--text);}
  .tablet{max-width:1900px; min-height:95vh; margin:16px auto; display:flex; border-radius:32px; overflow:hidden; background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01)); box-shadow:0 40px 120px rgba(0,0,0,.7);}
  .sidebar{width:300px; padding:26px 22px; background:linear-gradient(180deg,#020617,#020617 60%,#020617cc); border-right:1px solid rgba(255,255,255,.06); display:flex; flex-direction:column;}
  .sidebar h2{font-size:22px; margin-bottom:18px; letter-spacing:.3px;}
  .sidebar button{all:unset; padding:14px 18px; border-radius:16px; margin-bottom:10px; background:rgba(255,255,255,.03); cursor:pointer; display:flex; align-items:center; gap:12px; font-size:15px; transition:.25s ease;}
  .sidebar button:hover{background:linear-gradient(90deg,var(--accent),var(--accent-2));}
  .main{flex:1; padding:34px; overflow-y:auto;}
  section{background:var(--glass); backdrop-filter: blur(20px); padding:32px; border-radius:28px; margin-bottom:26px; border:1px solid rgba(255,255,255,.08);}
  h3{font-size:28px;margin-bottom:18px}
  h4{font-size:18px;margin:18px 0 10px;color:var(--muted)}
  input,select,textarea{width:100%; padding:16px 18px; margin-top:10px; background:rgba(2,6,23,.85); color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:18px; font-size:15px;}
  textarea{min-height:140px}
  button.action{margin-top:16px; padding:16px 26px; border-radius:20px; border:none; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; font-size:15px; cursor:pointer;}
  .role-judge{--accent:var(--judge);--accent-2:#fde047}
  .role-lspd{--accent:var(--lspd);--accent-2:#60a5fa}
  .role-marshal{--accent:var(--marshal);--accent-2:#4ade80}
  .role-doj{--accent:var(--doj);--accent-2:#c084fc}
  .card{background:rgba(2,6,23,.9); padding:18px 22px; border-radius:20px; margin-top:14px; border:1px solid rgba(255,255,255,.06); display:flex; justify-content:space-between; align-items:center;}
  .alert{background:linear-gradient(90deg,#7f1d1d,#ef4444); padding:18px; border-radius:20px; margin-top:14px; font-weight:600;}
  .popup{position:fixed; top:28px; right:28px; padding:20px 26px; border-radius:24px; background:linear-gradient(90deg,#7f1d1d,#ef4444); box-shadow:0 30px 60px rgba(0,0,0,.6); animation:slide .45s cubic-bezier(.4,0,.2,1);}
  @keyframes slide{from{transform:translateX(130%)} to{transform:translateX(0)}}
  .hidden{display:none}
</style>
</head>
<body>
<div class="tablet split">

  <header>
    <h2>üì± MDT System</h2>
    <div id="userInfo"></div>
  </header>

  <section id="login">
    <h3>Login</h3>
    <input id="username" placeholder="Benutzername" />
    <input id="password" type="password" placeholder="Passwort" />
    <button id="loginBtn">Einloggen</button>
  </section>

  <nav id="mainNav" class="hidden">
    <button onclick="show('dashboard')">Startseite</button>
    <button onclick="show('employees')">Employees</button>
    <button onclick="show('laws')">Panel Code</button>
    <button onclick="show('reports')">Einsatzberichte</button>
    <button onclick="show('persons')">Personenregister</button>
    <button onclick="show('vehicles')">Fahrzeuge</button>
    <button onclick="show('wanted')">üö® Wanted</button>
    <button onclick="show('judge')">‚öñÔ∏è Richter</button>
  </nav>

  <!-- Dashboard -->
  <section id="dashboard" class="hidden">
    <h3>Startseite</h3>
    <input placeholder="Person suchen" />
    <input placeholder="Kennzeichen suchen" />
    <input placeholder="Wanted suchen" />
    <input placeholder="Law suchen" />
  </section>

  <!-- Employees -->
  <section id="employees" class="hidden">
    <h3>üëÆ Beamten-Management</h3>
    <h4>Eigene Notizen</h4>
    <textarea id="myNotes" placeholder="Private Notizen (nur f√ºr dich sichtbar)"></textarea>
    <hr />
    <h4>Beamten registrieren</h4>
    <input id="empUsername" placeholder="Benutzername" />
    <input id="empPassword" placeholder="Startpasswort" />
    <select id="empRank">
      <option>LSPD Officer</option>
      <option>Detective</option>
      <option>Sergeant</option>
      <option>Marshal Officer</option>
      <option>Marshal Deputy</option>
      <option>Attorney</option>
      <option>Judge</option>
    </select>
    <button id="registerEmployeeBtn">Registrieren</button>
    <hr />
    <h4>Beamte verwalten</h4>
    <div id="employeeList"></div>
  </section>

  <!-- Panel Code / Laws -->
  <section id="laws" class="hidden">
    <h3>Panel Code</h3>
    <input placeholder="Law suchen" />
    <div id="lawList"></div>
  </section>

  <!-- Einsatzberichte -->
<section id="reports" class="hidden">
  <h3>Einsatzberichte</h3>
  <textarea id="reportText" placeholder="Einsatzbericht (Vorlage je Rang)"></textarea>
  <button id="saveReportBtn">Speichern</button>
</section>

  <!-- Personenregister -->
  <section id="persons" class="hidden">
    <h3>Personenregister</h3>
    <input id="firstName" placeholder="Vorname" />
    <input id="lastName" placeholder="Nachname" />
    <input id="birthDate" placeholder="Geburtsdatum" />
    <button id="addPersonBtn">Person anlegen</button>
  </section>

  <!-- Fahrzeug-Register -->
<section id="vehicles" class="hidden">
  <h3>Fahrzeugregister</h3>
  <input id="vehicleBrand" placeholder="Marke" />
  <input id="vehicleModel" placeholder="Modell" />
  <input id="vehicleColor" placeholder="Farbe" />
  <input id="vehiclePlate" placeholder="Kennzeichen" />
  <button id="addVehicleBtn">Fahrzeug registrieren</button>
</section>
    
  <!-- Wanted -->
  <section id="wanted" class="hidden">
    <h3>üö® Live-Fahndung</h3>
    <select id="wantedPerson"></select>
    <textarea id="wantedReason" placeholder="Grund f√ºr Fahndung"></textarea>
    <button id="flagWantedBtn">Fahndung ausl√∂sen</button>
    <hr />
    <h4>üîî Auto-Alerts</h4>
    <select id="vehicleSelect"></select>
    <button id="checkPlateBtn">Check</button>
    <div id="alertBox"></div>
  </section>

  <!-- Richter -->
  <section id="judge" class="hidden">
    <h3>‚öñÔ∏è Richter-Dashboard</h3>
    <h4>Haftbefehl</h4>
    <select id="judgePerson"></select>
    <textarea id="judgeReason" placeholder="Begr√ºndung"></textarea>
    <button id="issueWarrantBtn">Haftbefehl ausstellen</button>
    <hr />
    <h4>Ermittlung sperren / freigeben</h4>
    <select id="caseId"></select>
    <select id="caseAction">
      <option value="lock">Sperren</option>
      <option value="unlock">Freigeben</option>
    </select>
    <button id="toggleCaseBtn">Ausf√ºhren</button>
  </section>

</div>

    <!-- =================== JS =================== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, doc, addDoc, getDocs, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyCNYAjMBgtIh64g-siP9CytOZfyRKx-BSg",
  authDomain: "mdt-los-santos-horizon.firebaseapp.com",
  projectId: "mdt-los-santos-horizon",
  storageBucket: "mdt-los-santos-horizon.firebasestorage.app",
  messagingSenderId: "611944178614",
  appId: "1:611944178614:web:610fb342d748b5a027d717"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== SECTION SHOW/HIDE =====
window.show = (id) => {
  document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
};

// ===== LOGIN =====
document.getElementById('loginBtn').addEventListener('click', async () => {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;

  const snapshot = await getDocs(collection(db, "employees"));
  let found = false;
  snapshot.forEach(docSnap => {
    const e = docSnap.data();
    if (e.username === username && (!e.password || e.password === password)) {
      found = true;
      document.getElementById('userInfo').textContent = `Eingeloggt: ${username} | Rang: ${e.rank}`;
      window.currentUser = e; // speichere User global
    }
  });

  if (found) {
    document.getElementById('login').classList.add('hidden');
    document.getElementById('mainNav').classList.remove('hidden');
    show('dashboard');
  } else {
    alert("Benutzername oder Passwort falsch!");
  }
});

// ===== AUDIT LOG =====
window.writeAuditLog = async (type, targetId, action, user) => {
  try {
    await addDoc(collection(db, "auditLogs"), {
      type, targetId, action, user, timestamp: serverTimestamp(), immutable: true
    });
  } catch(err) { console.error("Audit Log Fehler:", err); }
};

// ===== EMPLOYEES =====
const employeeList = document.getElementById('employeeList');
async function loadEmployees() {
  employeeList.innerHTML = "";
  const snapshot = await getDocs(collection(db, "employees"));
  snapshot.forEach(docSnap => {
    const e = docSnap.data();
    const div = document.createElement('div');
    div.textContent = `üë§ ${e.username} | ${e.rank}`;
    employeeList.appendChild(div);
  });
}
loadEmployees();

// ===== REGISTER EMPLOYEE =====
document.getElementById('registerEmployeeBtn').addEventListener('click', async () => {
  const username = document.getElementById('empUsername').value;
  const rank = document.getElementById('empRank').value;
  if (!username || !rank) return alert('Bitte Benutzername und Rang ausf√ºllen');

  try {
    const docRef = await addDoc(collection(db, 'employees'), { username, rank, createdAt: serverTimestamp() });

    const names = username.split('.');
    await addDoc(collection(db, 'persons'), {
      firstName: names[0] || username,
      lastName: names[1] || 'DOE',
      autoCreated: true,
      createdAt: serverTimestamp()
    });

    alert('Mitarbeiter registriert und Personenakte erstellt');
    loadEmployees();
  } catch(err) { console.error(err); alert('Fehler beim Hinzuf√ºgen'); }
});

// ===== LAWS =====
const LAWS = [
  { id: '¬ß1', de: 'Geschwindigkeits√ºberschreitung (16 km/h √ºber)', fine: 500, jail: 0 },
  { id: '¬ß2', de: 'Fahren ohne Lizenz', fine: 1500, jail: 5 }
];
const lawList = document.getElementById('lawList');
LAWS.forEach(l => {
  const div = document.createElement('div');
  div.innerHTML = `<b>${l.id}</b> ‚Äì ${l.de} | ${l.fine}$ / ${l.jail} Monate`;
  lawList.appendChild(div);
});

// ===== PERSONEN REGISTRIEREN =====
document.getElementById('addPersonBtn').addEventListener('click', async () => {
  const firstName = document.getElementById('firstName').value;
  const lastName = document.getElementById('lastName').value;
  const birthDate = document.getElementById('birthDate').value;
  if(!firstName || !lastName || !birthDate) return alert('Bitte alle Felder ausf√ºllen');

  try {
    await addDoc(collection(db, 'persons'), { firstName, lastName, birthDate, createdAt: serverTimestamp() });
    alert('Person angelegt');
  } catch(err) { console.error(err); alert('Fehler beim Anlegen der Person'); }
});

// ===== WANTED SYSTEM =====
async function loadWantedPersons() {
  const snapshot = await getDocs(collection(db, "persons"));
  const wantedSelect = document.getElementById('wantedPerson');
  wantedSelect.innerHTML = "";
  snapshot.forEach(docSnap => {
    const p = docSnap.data();
    const option = document.createElement('option');
    option.value = docSnap.id;
    option.textContent = `${p.firstName} ${p.lastName}`;
    wantedSelect.appendChild(option);
  });
}
loadWantedPersons();

document.getElementById('flagWantedBtn').addEventListener('click', async () => {
  const personId = document.getElementById('wantedPerson').value;
  const reason = document.getElementById('wantedReason').value;
  if (!personId || !reason) return alert("Bitte Person und Grund ausw√§hlen!");
  try {
    await addDoc(collection(db, "wanted"), { personId, reason, flaggedAt: serverTimestamp() });
    writeAuditLog("person", personId, "flagWanted", window.currentUser?.username || "SYSTEM");
    alert(`Fahndung f√ºr ${personId} ausgel√∂st!`);
  } catch(err) { console.error(err); }
});

// ===== VEHICLE ALERTS =====
async function loadVehicles() {
  const snapshot = await getDocs(collection(db, "vehicles"));
  const vehicleSelect = document.getElementById('vehicleSelect');
  vehicleSelect.innerHTML = "";
  snapshot.forEach(docSnap => {
    const v = docSnap.data();
    const option = document.createElement('option');
    option.value = docSnap.id;
    option.textContent = `${v.brand} ${v.model} (${v.plate})`;
    vehicleSelect.appendChild(option);
  });
}
loadVehicles();

document.getElementById('checkPlateBtn').addEventListener('click', async () => {
  const vehicleId = document.getElementById('vehicleSelect').value;
  if (!vehicleId) return alert("Bitte Fahrzeug ausw√§hlen!");
  try {
    const docSnap = await getDoc(doc(db, "vehicles", vehicleId));
    if (docSnap.exists()) {
      const v = docSnap.data();
      document.getElementById('alertBox').textContent = `Fahrzeug: ${v.brand} ${v.model} (${v.plate})`;
    } else {
      document.getElementById('alertBox').textContent = "Fahrzeug nicht gefunden!";
    }
  } catch(err) { console.error(err); }
});

// ===== RICHTER DASHBOARD =====
async function loadJudgePersons() {
  const snapshot = await getDocs(collection(db, "persons"));
  const judgeSelect = document.getElementById('judgePerson');
  judgeSelect.innerHTML = "";
  snapshot.forEach(docSnap => {
    const p = docSnap.data();
    const option = document.createElement('option');
    option.value = docSnap.id;
    option.textContent = `${p.firstName} ${p.lastName}`;
    judgeSelect.appendChild(option);
  });
}
loadJudgePersons();

async function loadCases() {
  const snapshot = await getDocs(collection(db, "investigations"));
  const caseSelect = document.getElementById('caseId');
  caseSelect.innerHTML = "";
  snapshot.forEach(docSnap => {
    const c = docSnap.data();
    const option = document.createElement('option');
    option.value = docSnap.id;
    option.textContent = `${docSnap.id} | ${c.title || "Keine Beschreibung"}`;
    caseSelect.appendChild(option);
  });
}
loadCases();

document.getElementById('issueWarrantBtn').addEventListener('click', async () => {
  const personId = document.getElementById('judgePerson').value;
  const reason = document.getElementById('judgeReason').value;
  const judge = window.currentUser?.username || "Richter";
  if (!personId || !reason) return alert("Bitte Person und Begr√ºndung ausw√§hlen!");

  try {
    await addDoc(collection(db, "warrants"), { personId, reason, issuedBy: judge, issuedAt: serverTimestamp(), status: "active" });
    writeAuditLog("warrant", personId, "create", judge);
    alert(`Haftbefehl f√ºr ${personId} ausgestellt!`);
  } catch(err) { console.error(err); }
});

document.getElementById('toggleCaseBtn').addEventListener('click', async () => {
  const caseId = document.getElementById('caseId').value;
  const action = document.getElementById('caseAction').value;
  if (!caseId) return alert("Ermittlungs-ID fehlt!");
  try {
    await updateDoc(doc(db, "investigations", caseId), { locked: action === 'lock' });
    writeAuditLog("investigation", caseId, action, window.currentUser?.username || "Richter");
    alert(`Ermittlung ${caseId} ${action === 'lock' ? "gesperrt" : "freigegeben"}!`);
  } catch(err) { console.error(err); }
});

    // ===== FAHRZEUG-REGISTER =====
document.getElementById('addVehicleBtn').addEventListener('click', async () => {
  const brand = document.getElementById('vehicleBrand').value;
  const model = document.getElementById('vehicleModel').value;
  const color = document.getElementById('vehicleColor').value;
  const plate = document.getElementById('vehiclePlate').value;

  if (!brand || !model || !color || !plate) return alert("Bitte alle Felder ausf√ºllen");

  try {
    await addDoc(collection(db, "vehicles"), {
      brand, model, color, plate, createdAt: serverTimestamp()
    });
    alert(`Fahrzeug ${brand} ${model} (${plate}) registriert!`);
    writeAuditLog("vehicle", plate, "create", window.currentUser?.username || "SYSTEM");
    loadVehicles(); // Dropdown aktualisieren
  } catch(err) {
    console.error("Fehler Fahrzeug registrieren:", err);
  }
});

// ===== EINSATZBERICHTE =====
let reportCounter = 1;
window.createReportTitle = (rank, dept) => {
  const prefix = dept === 'LSPD' ? 'LSPD-EINSATZ-' : 'LSMS-EINSATZ-';
  return prefix + String(reportCounter++).padStart(5,'0');
};

document.getElementById('saveReportBtn').addEventListener('click', async () => {
  const reportText = document.getElementById('reportText').value;
  if (!reportText) return alert("Bitte Einsatzbericht ausf√ºllen");

  const rank = window.currentUser?.rank || "Officer";
  const dept = rank.includes("LSPD") ? "LSPD" : "LSMS";
  const title = createReportTitle(rank, dept);

  try {
    await addDoc(collection(db, "reports"), {
      title,
      text: reportText,
      createdBy: window.currentUser?.username || "SYSTEM",
      createdAt: serverTimestamp()
    });
    alert(`Einsatzbericht "${title}" gespeichert`);
    writeAuditLog("report", title, "create", window.currentUser?.username || "SYSTEM");
    document.getElementById('reportText').value = ""; // Input leeren
  } catch(err) {
    console.error("Fehler beim Speichern des Berichts:", err);
  }
});

</script>

    
